
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Runner Rehab Pro — PWA v1.1.1 (debug)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root { --bg:#0c0c0c; --card:#151515; --text:#eaeaea; --muted:#a0a0a0; --accent:#4ade80; --bad:#f87171; --line:#2a2a2a; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color:var(--text); background:linear-gradient(180deg,#0b0b0b 0%, #121212 100%); }
  header { padding:16px 18px; position:sticky; top:0; background:rgba(18,18,18,0.9); backdrop-filter: blur(6px); border-bottom:1px solid var(--line); }
  h1 { font-size:18px; margin:0 0 4px; }
  .sub { color:var(--muted); font-size:13px; }
  .wrap { max-width:1000px; margin:0 auto; padding:18px; display:grid; grid-template-columns: 1.2fr 1fr; gap:18px; }
  @media (max-width: 900px) { .wrap { grid-template-columns: 1fr; } }
  .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  label { font-size:12px; color:var(--muted); }
  select, input[type="text"], input[type="number"], input[type="range"]{ width:100%; background:#0f0f0f; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:8px; }
  .chk { display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#101010; }
  .chk input[type="checkbox"]{ width:18px; height:18px; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0e1a12; color:#9be7b0; border:1px solid #1f3b2b; font-size:12px; }
  .title { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
  .muted { color:var(--muted); font-size:12px; }
  .btns { display:flex; gap:8px; flex-wrap: wrap; }
  button { background:#161616; color:var(--text); border:1px solid var(--line); padding:8px 10px; border-radius:10px; font-weight:600; cursor:pointer; }
  button.accent { border-color:#2b5a3d; background:#0e1a12; color:#c6f6d5; }
  .svgWrap { width:100%; height:220px; border:1px solid var(--line); background:#0f0f0f; border-radius:12px; display:flex; align-items:center; justify-content:center; }
  .hint { font-size:12px; color:var(--muted); margin-top:8px; }
  .grid { display:grid; gap:10px; }
  .section { margin-top:8px; padding-top:8px; border-top:1px dashed var(--line); }
  .install { background:#0e1a12; border:1px solid #1f3b2b; color:#c6f6d5; border-radius:12px; padding:10px; font-size:13px; display:none; }
  .demoBtn { margin-left:auto; }
  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); }
  .modal .inner { background:#111; border:1px solid var(--line); border-radius:14px; width:min(680px, 94vw); padding:14px; }
  .modal header { position:relative; border:none; background:none; padding:6px 6px 10px; }
  .modal h3 { margin:0; font-size:16px; }
  .modal .content { background:#0f0f0f; border:1px solid var(--line); border-radius:12px; padding:10px; }
  .close { position:absolute; right:8px; top:6px; background:#171717; border:1px solid var(--line); border-radius:8px; padding:6px 8px; }
</style>

<script>
window.addEventListener('error', function(e){
  const warn = document.createElement('div');
  warn.style.cssText='background:#3b0f0f;color:#ffdada;padding:10px 14px;margin:10px 18px;border:1px solid #5a1a1a;border-radius:10px;font-size:12px;';
  warn.textContent = 'Script error: ' + (e.message || 'unknown');
  document.body.prepend(warn);
});
</script>
</head>
<body>
<header>
  <h1>Runner Rehab Pro — PWA v1.1.1 (debug)</h1>
  <div class="sub">Install to Home Screen for an app-like experience. Offline. Preloaded with your routine + demo animations.</div>
<div style="padding:0 18px 6px;color:#9be7b0;font-size:12px;">Build v1.1.1 (debug, no SW)</div></header>

<div class="wrap">
  <section class="card">
    <div class="title">
      <h2>Today</h2>
      <div id="todayPill" class="pill">—</div>
    </div>
    <div class="row">
      <div class="muted">Your routine below is preloaded. Check off what you complete. Tap “Save”.</div>
      <div class="muted" style="text-align:right">Pain today: <span id="painVal">0</span>/10</div>
    </div>

    <div class="section grid" id="form"></div>

    <div class="section">
      <label for="pain">Pain (0–10)</label>
      <input id="pain" type="range" min="0" max="10" step="1" value="0" />
      <div class="hint">If pain ≥ 5 after Strength, reduce volume next time.</div>
    </div>

    <div class="btns section">
      <button class="accent" id="saveBtn">Save</button>
      <button id="resetBtn">Reset Today</button>
    </div>
  </section>

  <section class="card">
    <div class="title"><h2>This Week — Adherence</h2></div>
    <div class="svgWrap">
      <svg id="chart" width="100%" height="220" viewBox="0 0 340 220" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Weekly adherence chart"></svg>
    </div>
    <div class="hint">Targets — Mobility: 6–7/wk • Activation: 3+/wk • Strength: 2–3/wk • Core: 2/wk</div>
  </section>
</div>

<div class="modal" id="demoModal" aria-hidden="true" role="dialog">
  <div class="inner">
    <header>
      <h3 id="demoTitle">Exercise Demo</h3>
      <button class="close" id="closeModal">Close</button>
    <div style="padding:0 18px 6px;color:#9be7b0;font-size:12px;">Build v1.1.1 (debug, no SW)</div></header>
    <div class="content" id="demoContent"></div>
  </div>
</div>

<script>
/* SW disabled in debug build */
  return state[todayStr];
}

function renderForm(day) {
  const elForm = document.getElementById("form");
  elForm.innerHTML = "";
  CATS.forEach(cat => {
    const items = day.data[cat] || [];
    const catWrap = document.createElement("div");
    catWrap.className = "grid";
    const head = document.createElement("div");
    head.className = "chk";
    head.innerHTML = `<strong style="flex:1">${cat}</strong><span class="muted">Tap demo ▶ on any exercise</span>`;
    catWrap.appendChild(head);

    items.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "grid";
      const baseId = (s)=> s.replace(/\W/g,"_");
      const srId = baseId(`sr_${cat}_${idx}`);
      const durId = baseId(`dur_${cat}_${idx}`);
      const chkId = baseId(`chk_${cat}_${idx}`);
      const demoBtnId = baseId(`demo_${cat}_${idx}`);

      row.innerHTML = `
        <div class="chk">
          <input id="${chkId}" type="checkbox" ${it.done ? "checked":""}/>
          <strong style="flex:1">${it.ex}</strong>
          <button class="demoBtn" id="${demoBtnId}">Demo ▶</button>
        </div>
        <div class="row">
          <div>
            <label>Sets x Reps</label>
            <input id="${srId}" type="text" placeholder="e.g., 3 x 10" value="${(it.sets && it.reps) ? (it.sets + " x " + it.reps) : ""}"/>
          </div>
          <div>
            <label>Duration (min)</label>
            <input id="${durId}" type="number" min="0" step="1" value="${it.dur || ""}"/>
          </div>
        </div>
      `;
      catWrap.appendChild(row);

      setTimeout(() => {
        document.getElementById(demoBtnId).addEventListener("click", ()=> showDemo(it.ex));
      }, 0);
    });

    elForm.appendChild(catWrap);
  });
}

function showDemo(exName) {
  const modal = document.getElementById("demoModal");
  const title = document.getElementById("demoTitle");
  const content = document.getElementById("demoContent");
  title.textContent = exName + " — Demo";
  content.innerHTML = "";
  const spec = MEDIA[exName];

  if (spec && spec.type === "video") {
    const v = document.createElement("video");
    v.controls = true;
    v.autoplay = true;
    v.src = spec.src;
    v.style.width = "100%";
    content.appendChild(v);
  } else if (spec && spec.type === "svg" && SVG_DEMOS[spec.id]) {
    content.innerHTML = SVG_DEMOS[spec.id];
  } else {
    content.innerHTML = `<div class="muted">No demo yet. Add one by editing MEDIA in index.html.</div>`;
  }
  modal.style.display = "flex";
}

function renderChart(state) {
  const elChart = document.getElementById("chart");
  const dates = [];
  for(let i=6;i>=0;i--) { const d=new Date(); d.setDate(d.getDate()-i); dates.push(d.toISOString().slice(0,10)); }
  const sums = { "Mobility":0, "Activation":0, "Strength":0, "Core/Stability":0 };
  const counts = { "Mobility":0, "Activation":0, "Strength":0, "Core/Stability":0 };

  dates.forEach(d => {
    const day = state[d];
    if(!day) return;
    Object.keys(sums).forEach(cat => {
      const items = (day.data && day.data[cat]) || [];
      if(items.length) counts[cat]++;
      const anyDone = items.some(x=>x.done);
      if(anyDone) sums[cat]++;
    });
  });

  const cats = Object.keys(sums);
  const perc = cats.map(cat => counts[cat] ? Math.round((sums[cat]/counts[cat])*100) : 0);

  const w = 320, h = 190, left = 90, top = 20, barH = 26, gap = 16;
  elChart.innerHTML = "";
  const title = document.createElementNS("http://www.w3.org/2000/svg","text");
  title.setAttribute("x", 10); title.setAttribute("y", 14);
  title.setAttribute("fill", "#a0a0a0"); title.setAttribute("font-size","12");
  title.textContent = "Last 7 Days — % days with any exercise done per category";
  elChart.appendChild(title);

  cats.forEach((cat, i) => {
    const y = top + i*(barH+gap);
    const label = document.createElementNS("http://www.w3.org/2000/svg","text");
    label.setAttribute("x", 10); label.setAttribute("y", y+barH-8);
    label.setAttribute("fill", "#cfcfcf"); label.setAttribute("font-size","12");
    label.textContent = cat;
    elChart.appendChild(label);

    const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
    bg.setAttribute("x", left); bg.setAttribute("y", y);
    bg.setAttribute("width", w-left-20); bg.setAttribute("height", barH);
    bg.setAttribute("rx","6"); bg.setAttribute("fill", "#1b1b1b"); bg.setAttribute("stroke","#2a2a2a");
    elChart.appendChild(bg);

    const val = perc[i];
    const fg = document.createElementNS("http://www.w3.org/2000/svg","rect");
    fg.setAttribute("x", left); fg.setAttribute("y", y);
    fg.setAttribute("width", Math.max(0,(w-left-20) * (val/100)));
    fg.setAttribute("height", barH); fg.setAttribute("rx","6"); fg.setAttribute("fill", "#4ade80");
    elChart.appendChild(fg);

    const pct = document.createElementNS("http://www.w3.org/2000/svg","text");
    pct.setAttribute("x", w-40); pct.setAttribute("y", y+barH-8);
    pct.setAttribute("fill", "#9be7b0"); pct.setAttribute("font-size","12");
    pct.setAttribute("text-anchor","end");
    pct.textContent = val + "%";
    elChart.appendChild(pct);
  });
}

function saveToday() {
  const state = loadState();
  const day = ensureToday(state);
  day.pain = parseInt(document.getElementById("pain").value,10)||0;

  CATS.forEach(cat => {
    const items = day.data[cat] || [];
    items.forEach((it, idx) => {
      const base = (s) => s.replace(/\W/g,"_");
      const chk = document.getElementById(base(`chk_${cat}_${idx}`));
      const sr  = document.getElementById(base(`sr_${cat}_${idx}`));
      const dur = document.getElementById(base(`dur_${cat}_${idx}`));
      it.done = !!(chk && chk.checked);
      const srVal = (sr && sr.value || "").toLowerCase();
      if (srVal.includes("x")) {
        const [s,r] = srVal.split("x").map(x=>x.trim());
        it.sets = s || ""; it.reps = r || "";
      } else {
        it.sets = ""; it.reps = "";
      }
      it.dur = (dur && dur.value) || "";
    });
  });

  state[todayStr] = day;
  saveState(state);
  flashSaved();
  renderChart(state);
}

function init() {
  const state = loadState();
  const day = ensureToday(state);

  document.getElementById("todayPill").textContent = new Date().toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
  const pain = document.getElementById("pain");
  pain.value = day.pain || 0;
  document.getElementById("painVal").textContent = pain.value;
  pain.addEventListener("input", () => document.getElementById("painVal").textContent = pain.value);

  renderForm(day);
  renderChart(state);

  document.getElementById("saveBtn").addEventListener("click", saveToday);
  document.getElementById("resetBtn").addEventListener("click", () => { const s=loadState(); delete s[todayStr]; saveState(s); location.reload(); });
  document.getElementById("closeModal").addEventListener("click", ()=> document.getElementById("demoModal").style.display = "none");
  document.getElementById("demoModal").addEventListener("click", (e)=>{ if(e.target.id==='demoModal') e.currentTarget.style.display='none'; });
}

function flashSaved(){
  const btn = document.getElementById("saveBtn");
  const txt = btn.textContent;
  btn.textContent = "Saved ✓";
  setTimeout(()=> btn.textContent = txt, 900);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
